<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Free your mind with JDBI</title>

  <meta name="description" content="Using explicit SQL mappers in Enterprise Applications">
  <meta name="author" content="Maciej Małecki">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>reveal.js</title>

  <link rel="stylesheet" href="dist/reset.css">
  <link rel="stylesheet" href="dist/reveal.css">
  <link rel="stylesheet" href="dist/theme/night.css" id="theme">
  <link rel="stylesheet" href="css/custom.css">

  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
</head>
<body>
<div class="reveal">
  <div class="slides">
    <!-- ----------------------------------------
               Title slide
    ----------------------------------------- -->
    <section data-background-image="img/super-mind.jpg" data-background-opacity="0.5">
      <h3>Free your mind with JDBI</h3>
      <p>using explicit SQL mappers...</p>
      <p>...in enterprise applications</p>
      <p style="font-size: 20px; margin-top: 8em; text-align: right">Maciej Małecki, Architecture Community, Capgemini
        2021.</p>
    </section>

    <!-- ----------------------------------------
               Introduction
    ----------------------------------------- -->
    <section data-auto-animate data-auto-animate-easing="cubic-bezier(0.770, 0.000, 0.175, 1.000)">
      <div class="r-vstack">
        <div data-id="arch-infra"
             style="background-color: #FFFFFF; width: 15em; height: 1.5em;"></div>
        <p class="small">&darr;</p>
        <div data-id="arch-app"
             style="background-color: #FF55FF; width: 15em; height: 1.5em;"></div>
        <p class="small">&darr;</p>
        <div data-id="arch-domain"
             style="background-color: #55FFFF; width: 15em; height: 1.5em;"></div>
        <p class="small">&darr;</p>
        <img data-id="arch-db" src="img/db.jpg" alt="db" style="height: 6em;">
      </div>
    </section>

    <section data-auto-animate data-auto-animate-easing="cubic-bezier(0.770, 0.000, 0.175, 1.000)" data-transition="fade">
      <div class="r-hstack">
        <div class="r-stack">
          <div data-id="arch-infra" style="background-color: #FFFFFF; width: 300px; height: 300px; border-radius: 200px;"></div>
          <div data-id="arch-app" style="background-color: #FF55FF; width: 200px; height: 200px; border-radius: 200px;"></div>
          <div data-id="arch-domain" style="background-color: #55FFFF; width: 100px; height: 100px; border-radius: 200px;"></div>
        </div>
        <p>&harr;</p>
        <img data-id="arch-db" src="img/db.jpg" alt="db" style="height: 4em;">
      </div>
    </section>

    <section data-auto-animate data-auto-animate-easing="cubic-bezier(0.770, 0.000, 0.175, 1.000)">
      <h2 data-id="title">Why?</h2>
      <div class="r-hstack">
        <img data-id="img" class="pane" src="img/hibernate-logo.png" alt="Hibernate Logo" style="margin: 0 0.8em 0 0.8em;">
        <div class="r-vstack">
          <div class="pane bcol0">1: SQL-POJO binding</div>
          <div class="pane bcol1">2: SQL dialect-agnostic</div>
          <div class="pane bcol2">3: transparent persistence</div>
        </div>
      </div>
    </section>

    <section data-auto-animate data-auto-animate-easing="cubic-bezier(0.770, 0.000, 0.175, 1.000)">
      <h2 data-id="title">Transparent persistence</h2>
      <div class="r-hstack">
        <div class="r-vstack">
          <div class="pane bcol0 fragment">change detection</div>
          <div class="pane bcol3 fragment">associations</div>
          <div class="r-hstack">
            <div class="pane bcol1 fragment">n+1</div>
            <div class="pane bcol2 fragment">proxies</div>
          </div>
          <div class="pane bcol4 fragment">no boundaries</div>
        </div>
        <img data-id="img" class="pane" src="img/hibernate-logo.png" alt="Hibernate Logo" style="margin: 0 0.8em 0 0.8em;">
        <div class="r-vstack">
          <div class="pane bcol1 fragment">fetching strategies</div>
          <div class="pane bcol2 fragment">entity graphs</div>
          <div class="pane bcol3 fragment">stateful session</div>
        </div>
      </div>
      <p class="fragment emph">&#8687;&#8687;&#8687; hidden complexity &#8687;&#8687;&#8687;</p>
    </section>

    <section data-auto-animate data-auto-animate-easing="cubic-bezier(0.770, 0.000, 0.175, 1.000)">
      <h3 data-id="title">What are the SQL mappers?</h3>
      <div class="r-vstack">
        <div class="pane bcol0">1: SQL-POJO binding</div>
        <div class="r-hstack">
          <img class="pane hsmall" src="img/jooq-logo-white.png" alt="JOOQ">
          <img data-id="jdbi-img" class="pane hsmall" src="img/jdbi.png" alt="JDBI">
          <img class="pane hsmall" src="img/spring-jdbc-logo.jpg" alt="spring">
        </div>
        <div class="r-hstack">
          <img class="pane" src="img/r2dbc.png" alt="r2dbc">
          <img class="pane hsmall fragment fade-out" data-fragment-index="2" src="img/jdbc.png" alt="JDBC">
        </div>
      </div>
    </section>

    <section data-auto-animate data-auto-animate-easing="cubic-bezier(0.770, 0.000, 0.175, 1.000)">
      <h3 data-id="title">When should I consider a mapper?</h3>
      <div class="r-hstack">
        <div class="r-vstack">
          <img class="pane hsmall" src="img/jooq-logo-white.png" alt="JOOQ">
          <img class="pane hsmall" data-id="jdbi-img" src="img/jdbi.png" alt="JDBI">
          <img class="pane hsmall" src="img/spring-jdbc-logo.jpg" alt="spring">
        </div>
        <div>
          <ul>
            <li>&#129477;, hexagonal, DDD</li>
            <li class="fragment" data-fragment-index="1">"read-only" app - dump data on screen</li>
            <li class="fragment" data-fragment-index="1">"write-only" app - data importers & updaters</li>
            <li class="fragment" data-fragment-index="2">CQRS</li>
            <li class="fragment" data-fragment-index="2">event sourcing</li>
            <li class="fragment" data-fragment-index="3">"small" apps of any kind</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ----------------------------------------
               JDBI Basics
    ----------------------------------------- -->
    <section data-auto-animate>
      <div class="r-hstack">
        <div class="r-vstack">
          <div class="pane bcol0 fragment">SQL &#8621; POJO mapper</div>
          <div class="pane bcol1 fragment">fluent API</div>
          <div class="pane bcol2 fragment">... or declarative API</div>
          <div class="pane bcol3 fragment">wraps around JDBC</div>
        </div>
        <img data-id="jdbi-img" class="pane hmed" src="img/jdbi.png" alt="JDBI">
        <div class="r-vstack">
          <div class="pane bcol4 fragment">native SQL</div>
          <div class="pane bcol3 fragment">no limitations</div>
          <div class="pane bcol2 fragment">no fake persistence</div>
          <div class="pane bcol1 fragment">get what you code</div>
          <div class="pane bcol0 fragment">(and nothing more)</div>
        </div>
      </div>
    </section>

    <section>
      <h3>JDBI</h3>
      <p class="small">example config in Spring</p>
      <pre><code class="hljs" data-trim data-line-numbers><script type="text/template">
        @Configuration
        public class JdbiConfiguration {
          private dataSource: DataSource; // +lombok or constructor stuff
          @Bean
          public Jdbi jdbi() {
            return Jdbi.create(dataSource).installPlugin(SqlObjectPlugin());
          }
        }
      </script></code></pre>
      <p class="small fragment" data-fragment-index="1">... and the same in Spring/Kotlin</p>
      <pre class="fragment kotlin" data-fragment-index="1"><code class="hljs" data-trim data-line-numbers><script type="text/template">
        @Configuration
        class JdbiConfiguration(private val dataSource: DataSource) {
          @Bean
          fun jdbi(): Jdbi = Jdbi.create(dataSource)
                                 .installPlugin(SqlObjectPlugin())
                                 .installPlugin(KotlinPlugin())
                                 .installPlugin(KotlinSqlObjectPlugin())
        }
      </script></code></pre>
    </section>

    <section>
      <h3>Simple SELECT</h3>
      <pre><code class="hljs" data-trim data-line-numbers="|4-7"><script type="text/template">
      public class UserRepository {
        private final Jdbi jdbi; // <-- inject somehow
        public List<User> findAllUsers() {
          return jdbi.withHandle(handle ->
            handle.createQuery("SELECT id, name FROM users ORDER BY name")
                  .mapToBean(User.class)
                  .list();
        }
      }
      </script></code></pre>

      <p class="small fragment">... and in Kotlin</p>
      <pre class="fragment kotlin"><code class="hljs" data-trim data-line-numbers><script type="text/template">
      class UserRepository(private val jdbi: Jdbi) {
        fun findAllUsers(): List<User> =
          jdbi.withHandle<List<User>, RuntimeException> { handle ->
            handle.createQuery("SELECT id, name FROM users ORDER BY name")
                  .mapToBean(User.class)
                  .list();
      }
      </script></code></pre>
    </section>

    <section>
      <h3>Simple INSERT</h3>
      <pre><code class="hljs" data-trim data-line-numbers><script type="text/template">
        int count = handle.createUpdate(
                      "INSERT INTO users(id, name) VALUES (:id, :name)")
                      .bind("id", 5)
                      .bind("name", "foo")
                      .execute();
      </script></code></pre>
      <p class="small fragment" data-fragment-index="1">or simply</p>
      <pre class="fragment" data-fragment-index="1"><code class="hljs" data-trim data-line-numbers><script type="text/template">
        int count = handle.createUpdate(
                      "INSERT INTO users(id, name) VALUES (?, ?)", 5, "foo")
                      .execute();
      </script></code></pre>
      <p class="small fragment" data-fragment-index="2">or bean mapped INSERT</p>
      <pre class="fragment" data-fragment-index="2"><code class="hljs" data-trim data-line-numbers><script type="text/template">
        int count = handle.createUpdate(
                      "INSERT INTO users(id, name) VALUES (:id, :name)")
                      .bindBean(new User(5, "foo")
                      .execute();
      </script></code></pre>
    </section>

    <section>
      <h3>Result beans</h3>
      <pre><code class="hljs" data-trim data-line-numbers><script type="text/template">
        public class User {
          public User(long id, String name) {
            // some Java nonsense
          }
          // some more nonsense
        }
      </script></code></pre>
      <p class="small fragment" data-fragment-index="1">if names are excluded from the bytecode</p>
      <pre class="fragment" data-fragment-index="1"><code class="hljs" data-trim data-line-numbers><script type="text/template">
        public class User {
          @ConstructorProperties({"id", "name"})
          public User(long id, String name) {
            // some Java nonsense
          }
          // some more nonsense
        }
      </script></code></pre>
      <p class="small fragment" data-fragment-index="2">... or use Kotlin</p>
      <pre class="fragment kotlin" data-fragment-index="2"><code class="hljs" data-trim data-line-numbers><script type="text/template">
        data class User(val id: Long, val name: String)
      </script></code></pre>
    </section>

    <!-- ----------------------------------------
               SQL Objects
    ----------------------------------------- -->
    <section>
      <h3>SQL Object</h3>
      <pre class="kotlin"><code class="hljs" data-trim data-line-numbers="|15|2-3|5-6|5-8|10-12"><script type="text/template">
      interface ManufacturerDao {
        @SqlQuery("SELECT id, name FROM Manufacturers ORDER BY name")
        fun selectAll(): List<ManufacturerRec>

        @SqlQuery("SELECT id, name FROM Manufacturers WHERE id=?")
        fun selectById(id: Long): ManufacturerRec?

        fun getById(id: Long) = selectById(id) ?: throw NotFoundException()

        @SqlUpdate("INSERT INTO Manufacturers (name) VALUES (:name)")
        @GetGeneratedKeys("id")
        fun insert(@BindBean manufacturer: ManufacturerRec): Long
      }

      data class ManufacturerRec(val id: Long?, val name: String)
      </script></code></pre>
    </section>

    <section>
      <h3>SQL Objects / Transactions</h3>
      <pre><code class="hljs kotlin" data-trim data-line-numbers="|2-6|4|5|8-14|16-21"><script type="text/template">
      class ManufacturerRepository(private val db: Jdbi) {
        fun findAll(): List<Manufacturer> =
          db.withHandle<List<Manufacturer>, RuntimeException> { handle ->
            val dao = handle.attach(ManufacturerDao::class.java)
            dao.selectAll().map { Manufacturer(it.id, it.name) }
          }

        fun findById(id: Long): Manufacturer? =
          db.withHandle<Manufacturer?, RuntimeException> { handle ->
            val dao = handle.attach(ManufacturerDao::class.java)
            dao.selectById(id)?.let {
              Manufacturer(ManufacturerAppId(it.id), it.name)
            }
          }

        fun persist(manufacturer: Manufacturer): Manufacturer =
          db.inTransaction<Manufacturer, RuntimeException> { handle ->
            val dao = handle.attach(ManufacturerDao::class.java)
            val id = dao.insert(ManufacturerRec(null, manufacturer.name)
            Manufacturer(id, manufacturer.name)
        }
      }
      </script></code></pre>
    </section>

    <section>
      <h3>Templating</h3>
      <p class="small">Find by criteria (Devonfw style)</p>
      <pre class="kotlin"><code class="hljs" data-trim data-line-numbers="|9-13|16-24|16-26"><script type="text/template">
      @SqlQuery("""
        SELECT
          items.name AS name, item_class_name, item_class_version,
          manufacturer_id, manufacturers.name AS manufacturer_name,
          manufacturers_code AS code
        FROM Items
        LEFT OUTER JOIN Manufacturers ON items.manufacturer_id = manufacturers.id
        WHERE
          1=1
          <if(name)>AND items.name LIKE :name<endif>
          <if(code)>AND manufacturers_code LIKE :code<endif>
          <if(ids)>AND manufacturer_id IN (<ids>)<endif>
          <if(itemClassIds)>AND item_class_name IN (<itemClassIds>)<endif>
        ORDER BY name"""
      )
      @DefineNamedBindings
      @UseStringTemplateEngine
      fun selectItemsByCriteria(
        @BindBean criteria: ItemSearchCriteria,
        @BindList("manufacturerIds", onEmpty = BindList.EmptyHandling.NULL_VALUE)
          ids: List<Long>?,
        @BindList("itemClassIds", onEmpty = BindList.EmptyHandling.NULL_VALUE)
          itemClassIds: List<String>?
      ): List<ItemWithManufacturerRec>

      data class ItemSearchCriteria(val name: String?, val code: String?)
			</script></code></pre>
    </section>

    <!-- ----------------------------------------
                   Advanced topics:
          persistence of entities and aggregates
    ----------------------------------------- -->
    <section data-background-image="img/harald.png" data-background-opacity="0.5">
      <h1>"advanced" topics</h1>
    </section>

    <section>
      <h3>Entity & event sourcing</h3>
      <pre class="kotlin"><code class="hljs" data-trim><script type="text/template">
      data class ItemStock(
        val itemName: String, val serial: Int, val amount: BigDecimal)
      </script></code></pre>
      <img src="img/item_stock.png" alt="Item stock" style="height: 100px;">
      <pre><code class="hljs" data-trim><script type="text/template">
        CREATE TABLE Item_Stock
        (
            item_name VARCHAR(50)    NOT NULL,
            amount    DECIMAL(10, 4) NOT NULL,
            serial    INT            NOT NULL,
            created   TIMESTAMP      NOT NULL DEFAULT now(),
            PRIMARY KEY (item_name, serial),
            FOREIGN KEY (item_name) REFERENCES Items (name)
        );
      </script></code></pre>
    </section>

    <section>
      <h3>DAO implementation for event sourcing</h3>
      <pre class="kotlin"><code class="hljs" data-trim data-line-numbers="1-12|14-19"><script type="text/template">
      interface ItemStockDao {
        @SqlUpdate("""
               INSERT INTO Item_Stock (item_name, serial, amount)
               VALUES (:name, :serial+1, :amount)""")
        fun insertItemStock(name: String, serial: Int, amount: BigDecimal): Int

        @SqlQuery("""
              SELECT
                item_name AS name, SUM(amount) AS amount, MAX(serial) AS serial
              FROM Item_Stock WHERE item_name=:name GROUP BY item_name""")
        fun selectStockAmount(name: String): ItemStock?
      }

      fun findByName(name: String): ItemStock =
        db.withHandle<ItemStock, RuntimeException> { handle ->
          val dao = handle.attach(ItemStockDao::class.java)
          return@withHandle itemStock = dao.selectStockAmount(name)
            ?: ItemStockRec(name, BigDecimal.ZERO, 0)
        }
			</script></code></pre>
    </section>

    <section>
      <h3>Optimistic locking</h3>
      <pre class="kotlin"><code class="hljs" data-trim data-line-numbers="1-3|5-6|8-11|13-20"><script type="text/template">
      @SqlQuery(
        "SELECT id, name, description, lock_counter FROM Items WHERE id=:id")
      fun selectItemById(id: Long): Item?

      data class Item(
        id: Long, name: String, description: String, lockCounter: Int)

      @SqlUpdate("""UPDATE Items
        SET name=:name, description=:description, lock_counter=:lockCounter+1
        WHERE id=:id AND lock_counter=:lockCounter""")
      fun updateItem(@BindBean item: Item): Int

      val item = selectItemById(15L) ?: throw NotFoundException()

      item.description = "New description"

      val updateCount = updateItem(item)
      if(updateCount != 1) {
        throw OptimisticLockException()
      }
			</script></code></pre>
    </section>

    <section>
      <h3>Classy CRUDs</h3>
      <pre class="kotlin"><code class="hljs" data-trim data-line-numbers="1-4|6-8|10-11|13-15"><script type="text/template">
      @SqlUpdate(
        "INSERT INTO Items (name, description) VALUES (:name, :description)")
      @GetGeneratedKeys
      fun insertItem(@BindBean item: Item): Long

      @SqlUpdate(
        "UPDATE Items SET name=:name, description=:description WHERE id=:id")
      fun updateItem(@BindBean item: Item): Int

      @SqlUpdate("DELETE FROM Items WHERE id=:id")
      fun deleteItem(id: Long): Int

      // + select
      // + select all
      // + search by criteria
      </script></code></pre>
    </section>

    <!-- ----------------------------------------
                   Summary and Q&A
    ----------------------------------------- -->
    <section>
      <h1>Q?</h1>
      <div class="r-hstack">
        <img src="img/qrcode.png" alt="QR">
        <div>
          <ul>
            <li>
              <a href="https://github.com/maciejmalecki/jdbi-slides">https://github.com/maciejmalecki/jdbi-slides</a>
            </li>
            <li>
              <a href="https://github.com/maciejmalecki/inventory">https://github.com/maciejmalecki/inventory</a>
            </li>
          </ul>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        width: 1200,
        hash: true,
        navigationMode: 'linear',
        slideNumber: 'c/t',
        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
</script>
</body>
</html>
